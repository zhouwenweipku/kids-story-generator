<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®è´ä¸“å±æ•…äº‹ç”Ÿæˆå™¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#8b5cf6',
          },
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">
  <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-md p-6 md:p-8">
    <h1 class="text-2xl md:text-3xl font-bold text-center text-primary mb-8">ğŸˆ å®è´ä¸“å±å„¿ç«¥æ•…äº‹ç”Ÿæˆå™¨</h1>

    <form id="storyForm" class="space-y-5">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700 font-medium mb-1" for="childName">å­©å­åå­— *</label>
          <input type="text" id="childName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="å¦‚ï¼šå°æ˜ã€æœµæœµ" required>
        </div>
        <div>
          <label class="block text-gray-700 font-medium mb-1" for="childAge">å­©å­å¹´é¾„ï¼ˆå²ï¼‰ *</label>
          <input type="number" id="childAge" min="3" max="12" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="3-12å²" required>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700 font-medium mb-1" for="childGender">å­©å­æ€§åˆ« *</label>
          <select id="childGender" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50" required>
            <option value="">è¯·é€‰æ‹©</option>
            <option value="ç”·">ç”·</option>
            <option value="å¥³">å¥³</option>
            <option value="ä¸é™">ä¸é™</option>
          </select>
        </div>
        <div>
          <label class="block text-gray-700 font-medium mb-1" for="protagonistType">ä¸»è§’ç±»å‹ *</label>
          <select id="protagonistType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50" required>
            <option value="">è¯·é€‰æ‹©</option>
            <option value="å°å…¬ä¸»">å°å…¬ä¸»</option>
            <option value="å°éª‘å£«">å°éª‘å£«</option>
            <option value="å°æé¾™">å°æé¾™</option>
            <option value="å°çŒ«">å°çŒ«</option>
            <option value="å°æœºå™¨äºº">å°æœºå™¨äºº</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700 font-medium mb-1" for="storyTheme">æ•…äº‹ä¸»é¢˜ *</label>
          <select id="storyTheme" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50" required>
            <option value="">è¯·é€‰æ‹©</option>
            <option value="å‹‡æ•¢å†’é™©">å‹‡æ•¢å†’é™©</option>
            <option value="å‹è°Š">å‹è°Š</option>
            <option value="ç¯ä¿">ç¯ä¿</option>
            <option value="æ¢ç´¢å¤ªç©º">æ¢ç´¢å¤ªç©º</option>
            <option value="å­¦ä¼šåˆ†äº«">å­¦ä¼šåˆ†äº«</option>
          </select>
        </div>
        <div>
          <label class="block text-gray-700 font-medium mb-1" for="storyScene">æ•…äº‹åœºæ™¯ *</label>
          <select id="storyScene" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50" required>
            <option value="">è¯·é€‰æ‹©</option>
            <option value="é­”æ³•æ£®æ—">é­”æ³•æ£®æ—</option>
            <option value="æœªæ¥åŸå¸‚">æœªæ¥åŸå¸‚</option>
            <option value="æµ·åº•ä¸–ç•Œ">æµ·åº•ä¸–ç•Œ</option>
            <option value="æœˆçƒ">æœˆçƒ</option>
          </select>
        </div>
      </div>

      <div>
        <label class="block text-gray-700 font-medium mb-1" for="value">ä¼ é€’çš„ä»·å€¼è§‚ï¼ˆå¯é€‰ï¼‰</label>
        <input type="text" id="value" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="å¦‚ï¼šä¹äºåŠ©äººã€å›¢ç»“å°±æ˜¯åŠ›é‡">
      </div>

      <div class="flex justify-center space-x-4 mt-6">
        <button type="submit" id="generateBtn" class="px-6 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors shadow-sm">ç”Ÿæˆæ•…äº‹</button>
        <button type="button" id="readBtn" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors shadow-sm disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>æœ—è¯»æ•…äº‹</button>
      </div>
    </form>

    <div id="loading" class="hidden text-center mt-8 text-primary">
      <p>âœ¨ æ­£åœ¨ä¸ºå®è´ç¼–ç»‡ä¸“å±æ•…äº‹...ï¼ˆ30ç§’å†…å®Œæˆï¼‰</p>
    </div>

    <div id="storyResult" class="mt-8 hidden space-y-4">
      <h2 class="text-xl font-bold text-gray-800 border-b pb-2">ğŸ“– ä¸“å±å„¿ç«¥æ•…äº‹</h2>
      <div id="storyContent" class="p-4 bg-gray-50 rounded-md whitespace-pre-line leading-relaxed"></div>
      <div id="illustrationTip" class="text-sm text-gray-600 italic p-2 bg-purple-50 rounded-md">æ’ç”»æç¤ºï¼š</div>
    </div>

    <div id="errorMsg" class="mt-6 hidden text-red-600 text-center p-2 bg-red-50 rounded-md"></div>
  </div>

  <script>
    // ========== å…³é”®ä¿®æ”¹ï¼šå¡«ä½ çš„é€šä¹‰åƒé—®API Key ==========
    const DASHSCOPE_API_KEY = "sk-a02a4b3262c4495ea7f329b98527e060";
    // ==================================================

    const form = document.getElementById('storyForm');
    const generateBtn = document.getElementById('generateBtn');
    const readBtn = document.getElementById('readBtn');
    const loading = document.getElementById('loading');
    const storyResult = document.getElementById('storyResult');
    const storyContent = document.getElementById('storyContent');
    const illustrationTip = document.getElementById('illustrationTip');
    const errorMsg = document.getElementById('errorMsg');

    // åŠ è½½å†å²è¾“å…¥
    window.onload = () => {
      const history = localStorage.getItem('storyFormData');
      if (history) {
        const data = JSON.parse(history);
        Object.keys(data).forEach(key => {
          const el = document.getElementById(key);
          if (el) el.value = data[key];
        });
      }
    };

    // è¡¨å•æäº¤
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = {
        childName: document.getElementById('childName').value,
        childAge: document.getElementById('childAge').value,
        childGender: document.getElementById('childGender').value,
        protagonistType: document.getElementById('protagonistType').value,
        storyTheme: document.getElementById('storyTheme').value,
        storyScene: document.getElementById('storyScene').value,
        value: document.getElementById('value').value,
      };

      localStorage.setItem('storyFormData', JSON.stringify(formData));

      loading.classList.remove('hidden');
      storyResult.classList.add('hidden');
      errorMsg.classList.add('hidden');
      generateBtn.disabled = true;
      readBtn.disabled = true;

      try {
        // ç›´æ¥è°ƒç”¨é€šä¹‰åƒé—®APIï¼ˆä¸ç”¨äº‘å‡½æ•°ï¼‰
        const prompt = `# ä¸ªæ€§åŒ–å„¿ç«¥æ•…äº‹ç”ŸæˆæŒ‡ä»¤
## è§’è‰²è®¾å®š
- å­©å­å§“åï¼š${formData.childName}
- å­©å­å¹´é¾„ï¼š${formData.childAge}å²
- å­©å­æ€§åˆ«ï¼š${formData.childGender}
- æ•…äº‹ä¸»è§’ç±»å‹ï¼š${formData.protagonistType}
- æ•…äº‹ä¸»é¢˜ï¼š${formData.storyTheme}
- æ•…äº‹åœºæ™¯ï¼š${formData.storyScene}
- æ ¸å¿ƒä»·å€¼è§‚/æ•™è‚²æ„ä¹‰ï¼š${formData.value || 'æ— ï¼Œä¿æŒæ¸©é¦¨ç§¯æå³å¯'}

## ç”Ÿæˆè¦æ±‚
1. éš¾åº¦é€‚é…ï¼š${formData.childAge}å²å„¿ç«¥èƒ½å¬æ‡‚ï¼Œ3-6å²çŸ­å¥ä¸ºä¸»ï¼Œ7-12å²å¯åŠ ç»†èŠ‚ï¼›
2. å­—æ•°æ§åˆ¶ï¼šä¸¥æ ¼600-1200å­—ï¼›
3. ç»“æ„ï¼šå¼€å¤´å¼•å…¥åœºæ™¯ä¸»è§’+ä¸­é—´ä¸»é¢˜æƒ…èŠ‚+ç»“å°¾ä»·å€¼è§‚ï¼›
4. æ’ç”»æç¤ºï¼šæ•…äº‹æœ«å°¾å•ç‹¬å†™ã€Œæ’ç”»æç¤ºï¼šXXXã€ï¼Œæè¿°å…·ä½“ç”»é¢ï¼›
5. é£æ ¼ï¼šæ¸©é¦¨ã€æœ‰è¶£ã€æ— æš´åŠ›ï¼Œä¸»è§’å¯ä»¥ç”¨å­©å­çš„åå­—ã€‚`;

        const res = await fetch('https://kids-story-generator-chi.vercel.app', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${DASHSCOPE_API_KEY}`,
          },
          body: JSON.stringify({
            model: 'qwen-plus',
            input: { prompt },
            parameters: {
              temperature: 0.7,
              max_tokens: 2000,
              result_format: 'text',
            },
          }),
        });

        const data = await res.json();
        if (res.ok && data.output?.text) {
          let story = data.output.text;
          let tip = 'æ— å…·ä½“æç¤ºï¼Œå¯æ ¹æ®æ•…äº‹å†…å®¹ç»˜åˆ¶ä¸»è§’åœºæ™¯';
          const tipIndex = story.indexOf('ã€Œæ’ç”»æç¤ºï¼š');
          if (tipIndex !== -1) {
            tip = story.slice(tipIndex).replace(/ã€Œ|ã€/g, '');
            story = story.slice(0, tipIndex).trim();
          }

          storyContent.textContent = story;
          illustrationTip.textContent = tip;
          storyResult.classList.remove('hidden');
          readBtn.disabled = false;
        } else {
          throw new Error(data.error || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      } catch (err) {
        errorMsg.textContent = `å‡ºé”™å•¦ï¼š${err.message}`;
        errorMsg.classList.remove('hidden');
      } finally {
        loading.classList.add('hidden');
        generateBtn.disabled = false;
      }
    });

    // æœ—è¯»åŠŸèƒ½
    readBtn.addEventListener('click', () => {
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(storyContent.textContent);
      utterance.lang = 'zh-CN';
      utterance.rate = 0.9;
      utterance.pitch = 1.2;
      window.speechSynthesis.speak(utterance);
    });
  </script>
</body>
</html>